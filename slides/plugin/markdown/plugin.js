/*! For license information please see plugin.js.LICENSE.txt */
import{marked}from"marked";const DEFAULT_SLIDE_SEPARATOR="\r?\n---\r?\n",DEFAULT_NOTES_SEPARATOR="notes?:",DEFAULT_ELEMENT_ATTRIBUTES_SEPARATOR="\\.element\\s*?(.+?)$",DEFAULT_SLIDE_ATTRIBUTES_SEPARATOR="\\.slide:\\s*?(\\S.+?)$",SCRIPT_END_PLACEHOLDER="__SCRIPT_END__",CODE_LINE_NUMBER_REGEX=/\[([\s\d,|-]*)\]/,HTML_ESCAPE_MAP={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"},Plugin=()=>{let e;function t(e){var t=(e.querySelector("[data-template]")||e.querySelector("script")||e).textContent,r=(t=t.replace(new RegExp("__SCRIPT_END__","g"),"<\/script>")).match(/^\n?(\s*)/)[1].length,a=t.match(/^\n?(\t*)/)[1].length;return a>0?t=t.replace(new RegExp("\\n?\\t{"+a+"}(.*)","g"),(function(e,t){return"\n"+t})):r>1&&(t=t.replace(new RegExp("\\n? {"+r+"}(.*)","g"),(function(e,t){return"\n"+t}))),t}function r(e){for(var t=e.attributes,r=[],a=0,n=t.length;a<n;a++){var o=t[a].name,s=t[a].value;/data\-(markdown|separator|vertical|notes)/gi.test(o)||(s?r.push(o+'="'+s+'"'):r.push(o))}return r.join(" ")}function a(e){return(e=e||{}).separator=e.separator||"\r?\n---\r?\n",e.notesSeparator=e.notesSeparator||"notes?:",e.attributes=e.attributes||"",e}function n(e,t){t=a(t);var r=e.split(new RegExp(t.notesSeparator,"mgi"));return 2===r.length&&(e=r[0]+'<aside class="notes">'+marked(r[1].trim())+"</aside>"),'<script type="text/template">'+(e=e.replace(/<\/script>/g,"__SCRIPT_END__"))+"<\/script>"}function o(e,t){t=a(t);for(var r,o,s,i=new RegExp(t.separator+(t.verticalSeparator?"|"+t.verticalSeparator:""),"mg"),u=new RegExp(t.separator),d=0,l=!0,c=[];r=i.exec(e);){!(o=u.test(r[0]))&&l&&c.push([]),s=e.substring(d,r.index),o&&l?c.push(s):c[c.length-1].push(s),d=i.lastIndex,l=o}(l?c:c[c.length-1]).push(e.substring(d));for(var p="",E=0,m=c.length;E<m;E++)c[E]instanceof Array?(p+="<section "+t.attributes+">",c[E].forEach((function(e){p+="<section data-markdown>"+n(e,t)+"</section>"})),p+="</section>"):p+="<section "+t.attributes+" data-markdown>"+n(c[E],t)+"</section>";return p}function s(e){return new Promise((function(a){var n=[];[].slice.call(e.querySelectorAll("section[data-markdown]:not([data-markdown-parsed])")).forEach((function(e,a){e.getAttribute("data-markdown").length?n.push(function(e){return new Promise((function(t,r){var a=new XMLHttpRequest,n=e.getAttribute("data-markdown"),o=e.getAttribute("data-charset");null!=o&&""!=o&&a.overrideMimeType("text/html; charset="+o),a.onreadystatechange=function(e,a){4===a.readyState&&(a.status>=200&&a.status<300||0===a.status?t(a,n):r(a,n))}.bind(this,e,a),a.open("GET",n,!0);try{a.send()}catch(s){console.warn("Failed to get the Markdown file "+n+". Make sure that the presentation and the file are served by a HTTP server and the file can be found there. "+s),t(a,n)}}))}(e).then((function(t,a){e.outerHTML=o(t.responseText,{separator:e.getAttribute("data-separator"),verticalSeparator:e.getAttribute("data-separator-vertical"),notesSeparator:e.getAttribute("data-separator-notes"),attributes:r(e)})}),(function(t,r){e.outerHTML='<section data-state="alert">ERROR: The attempt to fetch '+r+" failed with HTTP status "+t.status+".Check your browser's JavaScript console for more details.<p>Remember that you need to serve the presentation HTML from a HTTP server.</p></section>"}))):e.outerHTML=o(t(e),{separator:e.getAttribute("data-separator"),verticalSeparator:e.getAttribute("data-separator-vertical"),notesSeparator:e.getAttribute("data-separator-notes"),attributes:r(e)})})),Promise.all(n).then(a)}))}function i(e,t,r){var a,n,o=new RegExp(r,"mg"),s=new RegExp('([^"= ]+?)="([^"]+?)"|(data-[^"= ]+?)(?=[" ])',"mg"),i=e.nodeValue;if(a=o.exec(i)){var u=a[1];for(i=i.substring(0,a.index)+i.substring(o.lastIndex),e.nodeValue=i;n=s.exec(u);)n[2]?t.setAttribute(n[1],n[2]):t.setAttribute(n[3],"");return!0}return!1}function u(e,t,r,a,n){if(null!=t&&null!=t.childNodes&&t.childNodes.length>0)for(var o=t,s=0;s<t.childNodes.length;s++){var d=t.childNodes[s];if(s>0)for(var l=s-1;l>=0;){var c=t.childNodes[l];if("function"==typeof c.setAttribute&&"BR"!=c.tagName){o=c;break}l-=1}var p=e;"section"==d.nodeName&&(p=d,o=d),"function"!=typeof d.setAttribute&&d.nodeType!=Node.COMMENT_NODE||u(p,d,o,a,n)}t.nodeType==Node.COMMENT_NODE&&0==i(t,r,a)&&i(t,e,n)}function d(){var r=e.getRevealElement().querySelectorAll("[data-markdown]:not([data-markdown-parsed])");return[].slice.call(r).forEach((function(e){e.setAttribute("data-markdown-parsed",!0);var r=e.querySelector("aside.notes"),a=t(e);e.innerHTML=marked(a),u(e,e,null,e.getAttribute("data-element-attributes")||e.parentNode.getAttribute("data-element-attributes")||"\\.element\\s*?(.+?)$",e.getAttribute("data-attributes")||e.parentNode.getAttribute("data-attributes")||"\\.slide:\\s*?(\\S.+?)$"),r&&e.appendChild(r)})),Promise.resolve()}return{id:"markdown",init:function(t){e=t;let{renderer:r,animateLists:a,...n}=e.getConfig().markdown||{};return r||(r=new marked.Renderer,r.code=(e,t)=>{let r="";return CODE_LINE_NUMBER_REGEX.test(t)&&(r=t.match(CODE_LINE_NUMBER_REGEX)[1].trim(),r=`data-line-numbers="${r}"`,t=t.replace(CODE_LINE_NUMBER_REGEX,"").trim()),`<pre><code ${r} class="${t}">${e=e.replace(/([&<>'"])/g,(e=>HTML_ESCAPE_MAP[e]))}</code></pre>`}),!0===a&&(r.listitem=e=>`<li class="fragment">${e}</li>`),marked.setOptions({renderer:r,...n}),s(e.getRevealElement()).then(d)},processSlides:s,convertSlides:d,slidify:o,marked:marked}};export default Plugin;