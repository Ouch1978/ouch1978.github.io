import speakerViewHTML from"./speaker-view.html";import{marked}from"marked";const Plugin=()=>{let e,t,n=null;function a(){if(n&&!n.closed)n.focus();else{if(n=window.open("about:blank","reveal.js - Notes","width=1100,height=700"),n.marked=marked,n.document.write(speakerViewHTML),!n)return void alert("Speaker view popup failed to open. Please make sure popups are allowed and reopen the speaker view.");!function(){const a=t.getConfig().url,o="string"==typeof a?a:window.location.protocol+"//"+window.location.host+window.location.pathname+window.location.search;e=setInterval((function(){n.postMessage(JSON.stringify({namespace:"reveal-notes",type:"connect",state:t.getState(),url:o}),"*")}),500),window.addEventListener("message",r)}()}}function o(e){let a=t.getCurrentSlide(),o=a.querySelectorAll("aside.notes"),r=a.querySelector(".current-fragment"),i={namespace:"reveal-notes",type:"state",notes:"",markdown:!1,whitespace:"normal",state:t.getState()};if(a.hasAttribute("data-notes")&&(i.notes=a.getAttribute("data-notes"),i.whitespace="pre-wrap"),r){let e=r.querySelector("aside.notes");e?(i.notes=e.innerHTML,i.markdown="string"==typeof e.getAttribute("data-markdown"),o=null):r.hasAttribute("data-notes")&&(i.notes=r.getAttribute("data-notes"),i.whitespace="pre-wrap",o=null)}o&&(i.notes=Array.from(o).map((e=>e.innerHTML)).join("\n"),i.markdown=o[0]&&"string"==typeof o[0].getAttribute("data-markdown")),n.postMessage(JSON.stringify(i),"*")}function r(a){if(function(e){try{return window.location.origin===e.source.location.origin}catch(t){return!1}}(a)){let o=JSON.parse(a.data);o&&"reveal-notes"===o.namespace&&"connected"===o.type?(clearInterval(e),i()):o&&"reveal-notes"===o.namespace&&"call"===o.type&&function(e,a,o){let r=t[e].apply(t,a);n.postMessage(JSON.stringify({namespace:"reveal-notes",type:"return",result:r,callId:o}),"*")}(o.methodName,o.arguments,o.callId)}}function i(){t.on("slidechanged",o),t.on("fragmentshown",o),t.on("fragmenthidden",o),t.on("overviewhidden",o),t.on("overviewshown",o),t.on("paused",o),t.on("resumed",o),o()}return{id:"notes",init:function(e){t=e,/receiver/i.test(window.location.search)||(null!==window.location.search.match(/(\?|\&)notes/gi)?a():window.addEventListener("message",(e=>{if(!n&&"string"==typeof e.data){let o;try{o=JSON.parse(e.data)}catch(a){}o&&"reveal-notes"===o.namespace&&"heartbeat"===o.type&&(t=e.source,n&&!n.closed?n.focus():(n=t,window.addEventListener("message",r),i()))}var t})),t.addKeyBinding({keyCode:83,key:"S",description:"Speaker notes view"},(function(){a()})))},open:a}};export default Plugin;